<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />


<meta name="date" content="2023-06-14" />

<title>Vicmap for Beginners</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Vicmap for Beginners</h1>
<h4 class="date">2023-06-14</h4>



<!--
Modifications Copyright 2020 Rachel Swain and Justin Cally
Copyright 2019 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->
<div id="who-is-this-tutorial-for" class="section level2">
<h2>Who is this tutorial for?</h2>
<p>The purpose of this tutorial is:</p>
<ul>
<li>To introduce Vicmap</li>
<li>To explain the advantages of VicmapR in more detail</li>
<li>To provide simple examples of querying, visualising and working with
Vicmap spatial data</li>
</ul>
<p>The end goal of this tutorial is for R users with minimal spatial
experience to be able to search for, download and visualise Vicmap data.
While this tutorial is aimed at spatial beginners, it can still be used
as a reference for more experienced users.</p>
</div>
<div id="what-is-vicmap" class="section level2">
<h2>What is Vicmap?</h2>
<p>Vicmap is the Victorian Government’s catalogue of spatial datasets.
The catalogue features 454 datasets across land, property,
infrastructure and environment and is the most authoritative suite of
spatial data in Victoria.</p>
<div id="accessing-vicmap-datasets" class="section level3">
<h3>Accessing Vicmap datasets</h3>
<p>This data catalogue is freely available to the public and can be
accessed via several methods. For users of R, the fastest way to access
up to date Vicmap datasets is to utilise the Web Feature Service (WFS).
WFS is a standardised interface to request geographic information,
regardless of the platform on which it is stored.</p>
<p>WFS requires a URL that contains the instructions for the query and
is written in WFS specific terminology. This of course requires
understanding of the WFS terminology and the time-consuming process of
manually building the URL string.</p>
</div>
</div>
<div id="enter-vicmapr." class="section level2">
<h2>Enter, VicmapR.</h2>
<div id="wfs-without-the-fuss" class="section level4">
<h4>WFS, without the fuss!</h4>
<p>VicmapR simplifies WFS queries by taking user supplied keywords and
automatically building the correctly formatted URL string.<br />
The functions in VicmapR therefore provide a much faster and more robust
method for acquiring Vicmap data.</p>
</div>
<div id="lazy-evaluation" class="section level4">
<h4>Lazy evaluation</h4>
<p>VicmapR uses <em>lazy evaluation</em>, in which we query but do not
collect the data from the Vicmap database. This is called making a
‘Vicmap Promise’. A Vicmap Promise contains the dataset information but
not the data itself. This promise can be filtered for a subset of the
data before collecting. Using lazy evaluation we can collect the desired
subset, instead of the entire dataset.</p>
</div>
</div>
<div id="worked-example---melbournes-tram-network" class="section level2">
<h2>Worked Example - Melbourne’s Tram Network</h2>
<p><em>Note: A previous version of this tutorial used swooping birds as
the example, but due to the migration of platforms that data was not
available at time of writing</em></p>
<p>To demonstrate VicmapR’s features, we will download and explore a
dataset from the Vicmap catalogue. The data is a spatial dataset of
Melbourne’s tram network.</p>
<!-- Australian spring is famous for the presence of swooping birds. Certain species of birds swoop during the breeding season to protect their nest from potential predators. Swooping birds in Victoria include the masked lapwing (plover), butcherbird, magpie-lark, noisy miner and perhaps most famously, the magpie. The Vicmap catalogue has a dataset of 'swoop' locations, recorded by members of the public.  -->
<div id="searching-for-data" class="section level3">
<h3>Searching for data</h3>
<p>First, we need to search for the dataset. We can view all layers, or
do a keyword search. Use <code>ignore.case = TRUE</code> for a
case-insensitive search. <code>listLayers()</code> by default now
provides a column of ‘Abstract’ and ‘metadataID’. You can remove these
columns by setting the abstract argument to FALSE
(e.g. <code>listLayers(abstract = FALSE)</code>)</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#All layers</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>all_layers <span class="ot">&lt;-</span> <span class="fu">listLayers</span>() </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Case insensitive keyword search</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>search <span class="ot">&lt;-</span> <span class="fu">listLayers</span>(<span class="at">pattern =</span> <span class="st">&quot;tram&quot;</span>, <span class="at">ignore.case =</span> T) </span></code></pre></div>
<p>Viewing our search results shows us the name of the dataset and its
description.</p>
<p>Once we have the name of the Vicmap dataset we would like to
download, in this case <em>‘open-data-<a href="platform:ptv_metro_tram_route" class="uri">platform:ptv_metro_tram_route</a>’</em>, we can query the
Vicmap database.</p>
<p>If we are still not sure from the name and description that this is
the right dataset, we can look at the Vicmap Promise to get a snippet of
the dataset contents.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vicmap_query</span>(<span class="at">layer =</span> <span class="st">&quot;open-data-platform:ptv_metro_tram_route&quot;</span>) </span></code></pre></div>
<p>We can see that the dataset contains the route numbers and names. At
a glance this data should be adequate. If you want more extensive
information of the data you can use <code>get_metadata()</code> to
download a list of (i) metadata about the data, (ii) a data dictionary
(<em>work-in-progress</em>) and (iii) a link to the metadata url.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>metadata <span class="ot">&lt;-</span> <span class="fu">vicmap_query</span>(<span class="at">layer =</span> <span class="st">&quot;open-data-platform:ptv_metro_tram_route&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_metadata</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  .[[<span class="dv">1</span>]]</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">kbl</span>(metadata) <span class="sc">%&gt;%</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code></pre></div>
</div>
<div id="downloading-the-data" class="section level3">
<h3>Downloading the data</h3>
<p>The summary also shows that there are rows in this dataset. This
isn’t a very large dataset, but if we are using this data in an
interactive report or application, waiting to download the full dataset
may be impractical.</p>
<p>Using lazy evaluation, we can use pipes to filter and subset the
data, so that we only collect the desired subset. For example, let’s
just look at the first 10 rows.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="fu">vicmap_query</span>(<span class="at">layer =</span> <span class="st">&quot;open-data-platform:ptv_metro_tram_route&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>query</span></code></pre></div>
</div>
<div id="subsetting-data" class="section level3">
<h3>Subsetting data</h3>
<p>Now let’s only look at the tram route data. Note that VicmapR
datasets will retain <code>id</code> and <code>geometry</code> columns
even if not selected in the VicmapR promise. As this a simple features
(sf) dataset, the geometry corresponding to the features does not need
to be selected as it is always attached. The geometry column can only be
removed intentionally, for example, by using the
<code>st_drop_geometry()</code> function in the <code>sf</code>
package.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>tram_select <span class="ot">&lt;-</span> <span class="fu">vicmap_query</span>(<span class="at">layer =</span> <span class="st">&quot;open-data-platform:ptv_metro_tram_route&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(operator_name <span class="sc">==</span> <span class="st">&quot;Yarra Trams&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(num_of_stops <span class="sc">&gt;</span> <span class="dv">20</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(route_id, route_short_name, trip_headsign, operator_name, route_km) <span class="sc">%&gt;%</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>tram_select <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>id) <span class="sc">%&gt;%</span> <span class="co">#condense table for viewing</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code></pre></div>
<p><strong>By filtering the <code>Vicmap_promise</code> before
collecting, we have downloaded only a subset of rows of
data.</strong></p>
</div>
<div id="quick-visualisation-of-spatial-data-with-the-mapview-package" class="section level3">
<h3>Quick visualisation of spatial data with the <code>mapview</code>
package</h3>
<p>Often the first thing we want to do is see the data on a map. The
simplest and quickest way to visualise spatial data is to use the
<code>mapview</code> package:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mapview)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mapviewOptions</span>(<span class="at">fgb =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Because the dataset is not big we can download all the data as &#39;tram_route&#39;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>tram_route <span class="ot">&lt;-</span> <span class="fu">vicmap_query</span>(<span class="at">layer =</span> <span class="st">&quot;open-data-platform:ptv_metro_tram_route&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># plot data</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">mapview</span>(tram_route)</span></code></pre></div>
<p>While the output is basic, it is very simple to achieve and lines can
be clicked on to obtain the details from the other fields.</p>
</div>
<div id="visualisation-with-leaflet" class="section level3">
<h3>Visualisation with <code>leaflet</code></h3>
<p>For more customization, you might want to consider plotting your map
in <code>leaflet</code>. Leaflet is JavaScript library that allows users
to produce interactive maps that work efficiently across most desktop
and mobile platforms. Using the leaflet package in R, we have the
flexibility of plotting more complex map products.</p>
<p>We will start by plotting the most basic map in leaflet. Instead of
using a single function like <code>mapview()</code>, in leaflet we need
to add each component to the map. At a minimum we specify the leaflet
object, add a basemap and add the markers. Note: differing to mapview,
leaflet does not include marker labels by default, these must be added
with the <code>popup</code> parameter.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a palette</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">colorFactor</span>(<span class="st">&quot;Accent&quot;</span>, <span class="at">levels =</span> tram_route<span class="sc">$</span>trip_headsign) <span class="co">#define a colour palette</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>tram_route <span class="sc">%&gt;%</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">leaflet</span>() <span class="sc">%&gt;%</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addProviderTiles</span>(providers<span class="sc">$</span>CartoDB.Positron) <span class="sc">%&gt;%</span> <span class="co">#add third party base map</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPolylines</span>(</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="sc">~</span><span class="fu">pal</span>(trip_headsign),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">weight =</span> <span class="dv">2</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">stroke =</span> <span class="fl">0.5</span>, <span class="co">#removes outline</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">fillOpacity =</span> <span class="fl">0.8</span>,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">popup =</span> <span class="fu">paste0</span>(<span class="st">&quot;&lt;b&gt;Route No.: &lt;/b&gt;&quot;</span>, tram_route<span class="sc">$</span>route_short_name, <span class="st">&quot;&lt;br&gt;&quot;</span>, <span class="co">#format the popup with html tags</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;&lt;b&gt;Route Name: &lt;/b&gt;&quot;</span>, tram_route<span class="sc">$</span>trip_headsign, <span class="st">&quot;&lt;br&gt;&quot;</span>,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;&lt;b&gt;Distance (km): &lt;/b&gt;&quot;</span>, tram_route<span class="sc">$</span>route_km)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
</div>
<div id="spatial-filtering" class="section level3">
<h3>Spatial filtering</h3>
<p>Let’s say we want to know about the tram routes only in our LGA
(e.g. Darebin). We can apply a spatial filter to our dataset so that
only the tram routes in our suburb are shown. Where do we get the
spatial data for our LGA? From the Vicmap catalogue of course!</p>
<div id="the-sf-package" class="section level4">
<h4>The sf package</h4>
<p>The <code>sf</code> package for R provides tools for dealing with
‘simple feature’ datasets, i.e. a data frame or tibble with a geometry
list-column. The sf package allows us to manupulate spatial data and
perform spatial operations. In this case, we want to find which points
in our tram route data intersect with the polygon for our suburb
polygon.</p>
<p>To do this we can use <code>sf::st_intersection()</code>. Before
performing any spatial operations on a dataset, you want to make sure
the coordinate reference system (crs) is correct and if there are
multiple datasets, that the crs is the same for each dataset. You can
check the crs system with <code>sf::st_crs()</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Suburb polygon for Darebin</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>darebin <span class="ot">&lt;-</span> <span class="fu">vicmap_query</span>(<span class="at">layer =</span> <span class="st">&quot;open-data-platform:lga_polygon&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(lga_name) <span class="sc">%&gt;%</span> </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(lga_name <span class="sc">==</span> <span class="st">&quot;DAREBIN&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_make_valid</span>() <span class="co"># magic fix for some spatial data</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Check crs for each spatial dataset</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>sf<span class="sc">::</span><span class="fu">st_crs</span>(darebin) <span class="sc">==</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(tram_route)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Intersection</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>darebin_trams <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_intersection</span>(tram_route, darebin)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="fu">mapview</span>(darebin_trams) <span class="sc">+</span> <span class="fu">mapview</span>(darebin, <span class="at">alpha.regions =</span> <span class="fl">0.3</span>, <span class="at">col.regions=</span> <span class="st">&quot;green&quot;</span>)</span></code></pre></div>
</div>
<div id="filtering-within-a-radius" class="section level4">
<h4>Filtering within a radius</h4>
<p>We probably regularly travel a bit further afield though, so lets
look at a radius from our home address. We can create the radius
geometry with <code>st_buffer()</code> but first need to define the
coordinates for the centre of the radius (home). Don’t forget to specify
the crs as 4326 as we are dealing with a latitude and longitude
coordinate system.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>lat <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">37.75215888969604</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>lon <span class="ot">&lt;-</span> <span class="fl">145.02927170548745</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>home <span class="ot">&lt;-</span> <span class="fu">st_sfc</span>(<span class="fu">st_point</span>(<span class="fu">c</span>(lon, lat)), <span class="at">crs =</span> <span class="dv">4326</span>)</span></code></pre></div>
<p>We have a problem though, latitude and longitude units are degrees
and <code>st_buffer()</code> assumes units of meters. To convert from
degrees to metres we need to project our latitude and longitude, which
are represented as a point on a curved surface, onto a flat plane. To do
this, we use a projection standard chosen specifically for the zone
containing the coordinates. The standard is called the EPSG code and for
our coordinates is zone 55.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Project coordinates</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>home_utm <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(home, <span class="st">&quot;+proj=utm +zone=55&quot;</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get buffer</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>home_radius <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_buffer</span>(home_utm, <span class="at">dist =</span> <span class="dv">10000</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">mapview</span>(home_utm) <span class="sc">+</span> <span class="fu">mapview</span>(home_radius)</span></code></pre></div>
<p>Now we can use this radius to filter our tram route data. Don’t
forget, we need to convert the crs to 4283 to work with our tram route
data</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(home_radius) <span class="co">#crs is UTM Zone 55</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>home_radius <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(home_radius, <span class="at">crs =</span> <span class="dv">4283</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(home_radius)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>tram_route_10k <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(tram_route, home_radius)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">mapview</span>(tram_route_10k) <span class="sc">+</span> <span class="fu">mapview</span>(home_radius, <span class="at">alpha.regions =</span> <span class="fl">0.3</span>, <span class="at">col.regions =</span> <span class="st">&quot;green&quot;</span>)</span></code></pre></div>
</div>
<div id="finding-nearby-points" class="section level4">
<h4>Finding nearby points</h4>
<p>Let’s say we feel like a bike ride. We’ve picked a route but want to
know which areas to avoid so as not to get caught in tram tracks.</p>
<p>We can solve this problem in a similar way, using
<code>st_intersection()</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load bike route</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>route_line <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">system.file</span>(<span class="st">&quot;shapes/cycle_route.geojson&quot;</span>, <span class="at">package=</span><span class="st">&quot;VicmapR&quot;</span>), <span class="at">quiet =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="dv">4283</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">#Add buffer to route - we need to convert to m to do this (same as before)</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>route_m <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(route_line, <span class="st">&quot;+proj=utm +zone=55&quot;</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>tram_m <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(tram_route, <span class="st">&quot;+proj=utm +zone=55&quot;</span>) <span class="co"># convert to same crs for st_intersection</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>trams_en_route <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(route_m,tram_m)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Recorded tram tracks within 300m of the route</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="fu">mapview</span>(trams_en_route, <span class="at">col.regions =</span> <span class="st">&quot;Black&quot;</span>) <span class="sc">+</span> <span class="fu">mapview</span>(route_line)</span></code></pre></div>
</div>
</div>
</div>
<div id="using-the-vicmapr-geometric-filters" class="section level2">
<h2>Using the VicmapR Geometric Filters</h2>
<p>The VicmapR package offers tools for geometric filtering that avoid
the need for sf package. The WFS Geoserver on which Vicmap is based
supports several geometric filters - see the full list <a href="https://justincally.github.io/VicmapR/articles/query_vicmap.html#geometric-filters">here</a>.</p>
<p>These geometric filters allow us to perform basic spatial
manipulation while retaining the benefits of lazy evaluation. So as
before, if we want to filter our data before downloading, we can do so
with more complex spatial operations. This is particularly useful when
presenting VicmapR data in an interactive map, as it reduces the time
for downloading data between re-rendering the map.</p>
<p>Let’s revisit our examples above. To get the tram routes only in
Darebin we can filter with <code>INTERSECTS()</code>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># trams in Darebin</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>darebin_trams <span class="ot">&lt;-</span> <span class="fu">vicmap_query</span>(<span class="at">layer =</span> <span class="st">&quot;open-data-platform:ptv_metro_tram_route&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">INTERSECTS</span>(darebin)) <span class="sc">%&gt;%</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mapview</span>(darebin_trams) <span class="sc">+</span> <span class="fu">mapview</span>(darebin, <span class="at">alpha.regions =</span> <span class="fl">0.3</span>, <span class="at">col.regions =</span> <span class="st">&quot;orange&quot;</span>)</span></code></pre></div>
<p>And finally, the tram routes on our cycling route. To find tram
tracks within 30m we use the <code>INTERSECTS()</code> function and the
cycling route with an added 300m buffer. Note: VicmapR geometric filters
will be simplified, thus if precise intersections are desired, it is
advised to do a cleanup of the filtered data once collected.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>route_line <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">system.file</span>(<span class="st">&quot;shapes/cycle_route.geojson&quot;</span>, <span class="at">package=</span><span class="st">&quot;VicmapR&quot;</span>), <span class="at">quiet =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="dv">4283</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Condense line object</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>route_poly <span class="ot">&lt;-</span> route_line <span class="sc">%&gt;%</span> </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="dv">3111</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_buffer</span>(<span class="dv">30</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="st">&quot;POLYGON&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="dv">4283</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>route_intersection <span class="ot">&lt;-</span> <span class="fu">vicmap_query</span>(<span class="at">layer =</span> <span class="st">&quot;open-data-platform:ptv_metro_tram_route&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">INTERSECTS</span>(route_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_intersection</span>(route_poly)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>mapview<span class="sc">::</span><span class="fu">mapview</span>(route_poly) <span class="sc">+</span> mapview<span class="sc">::</span><span class="fu">mapview</span>(route_intersection, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>, <span class="at">lwd =</span> <span class="dv">5</span>)</span></code></pre></div>
</div>
<div id="debrief" class="section level2">
<h2>Debrief</h2>
<p>After completing this tutorial you should have a basic understanding
of plotting spatial data and performing some basic spatial operations.
This tutorial is a quick guide and designed only to get you started. For
further learning, see the following resources:</p>
<ul>
<li><a href="https://r-spatial.github.io/sf/">Simple Features for
R</a></li>
<li><a href="http://rstudio.github.io/leaflet/">Leaflet for R</a></li>
<li><a href="https://rspatial.org/intr/1-introduction.html">Introduction
to Spatial Data Science in R</a></li>
</ul>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
